<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Uma Agarwal">

<title>PM 566 Lab 5</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="lab5_files/libs/clipboard/clipboard.min.js"></script>
<script src="lab5_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="lab5_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="lab5_files/libs/quarto-html/popper.min.js"></script>
<script src="lab5_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="lab5_files/libs/quarto-html/anchor.min.js"></script>
<link href="lab5_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="lab5_files/libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="lab5_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="lab5_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="lab5_files/libs/bootstrap/bootstrap-81267100e462c21b3d6c0d5bf76a3417.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<link href="lab5_files/libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet">
<script src="lab5_files/libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<script src="lab5_files/libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="lab5_files/libs/leaflet-1.3.1/leaflet.css" rel="stylesheet">
<script src="lab5_files/libs/leaflet-1.3.1/leaflet.js"></script>
<link href="lab5_files/libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet">
<script src="lab5_files/libs/proj4-2.6.2/proj4.min.js"></script>
<script src="lab5_files/libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="lab5_files/libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet">
<script src="lab5_files/libs/leaflet-binding-2.2.3/leaflet.js"></script>


</head>

<body class="fullcontent quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">PM 566 Lab 5</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Uma Agarwal </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.4     ✔ readr     2.1.5
✔ forcats   1.0.0     ✔ stringr   1.5.1
✔ ggplot2   3.5.2     ✔ tibble    3.3.0
✔ lubridate 1.9.4     ✔ tidyr     1.3.1
✔ purrr     1.1.0     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(leaflet)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>met <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"/Users/umaagarwal/MyDocuments/USC/PM566/PM566-labs/data/met_all.gz"</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>met <span class="ot">&lt;-</span> met[met<span class="sc">$</span>temp <span class="sc">&gt;</span> <span class="sc">-</span><span class="dv">17</span> <span class="sc">|</span> <span class="fu">is.na</span>(met<span class="sc">$</span>temp), ]</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>met<span class="sc">$</span>elev[met<span class="sc">$</span>elev <span class="sc">==</span> <span class="fl">9999.0</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>met<span class="sc">$</span>week <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">format</span>(<span class="fu">as.Date</span>(<span class="fu">paste</span>(met<span class="sc">$</span>year, </span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>                                            met<span class="sc">$</span>month, </span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>                                            met<span class="sc">$</span>day, </span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">sep =</span> <span class="st">"-"</span>)), <span class="st">"%U"</span>))</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>met <span class="ot">&lt;-</span> met[met<span class="sc">$</span>week <span class="sc">==</span> <span class="fu">min</span>(met<span class="sc">$</span>week, <span class="at">na.rm =</span> T), ]</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>met_avg <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(<span class="fu">cbind</span>(temp, rh, wind.sp, vis.dist, </span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>                           dew.point, lat, lon, elev, atm.press)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>                     <span class="sc">~</span>USAFID, <span class="at">data =</span> met, <span class="at">FUN =</span> mean, <span class="at">na.rm =</span> T)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>met_avg<span class="sc">$</span>region <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(met_avg<span class="sc">$</span>lon <span class="sc">&gt;</span> <span class="sc">-</span><span class="dv">98</span> <span class="sc">&amp;</span> met_avg<span class="sc">$</span>lat <span class="sc">&gt;</span> <span class="fl">39.71</span>, <span class="st">"north east"</span>,</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">ifelse</span>(met_avg<span class="sc">$</span>lon <span class="sc">&gt;</span> <span class="sc">-</span><span class="dv">98</span> <span class="sc">&amp;</span> </span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>                                  met_avg<span class="sc">$</span>lat <span class="sc">&lt;</span> <span class="fl">39.71</span>, <span class="st">"south east"</span>,</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">ifelse</span>(met_avg<span class="sc">$</span>lon <span class="sc">&lt;</span> <span class="sc">-</span><span class="dv">98</span> <span class="sc">&amp;</span> met_avg<span class="sc">$</span>lat <span class="sc">&gt;</span> <span class="fl">39.71</span>, </span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"north west"</span>, <span class="st">"south west"</span>)))</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>met_avg<span class="sc">$</span>elev_cat <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(met_avg<span class="sc">$</span>elev <span class="sc">&gt;</span> <span class="dv">252</span>, <span class="st">"high"</span>, <span class="st">"low"</span>)</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>stations <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"https://noaa-isd-pds.s3.amazonaws.com/isd-history.csv"</span>)</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>stations<span class="sc">$</span>USAF <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(stations<span class="sc">$</span>USAF)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: NAs introduced by coercion</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Dealing with blanks and 999999</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>stations<span class="sc">$</span>USAF[stations<span class="sc">$</span>USAF <span class="sc">==</span> <span class="dv">999999</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>stations<span class="sc">$</span>CTRY[stations<span class="sc">$</span>CTRY <span class="sc">==</span> <span class="st">""</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>stations<span class="sc">$</span>STATE[stations<span class="sc">$</span>STATE <span class="sc">==</span> <span class="st">""</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Selecting the three relevant columns, and keeping unique records</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>stations <span class="ot">&lt;-</span> <span class="fu">unique</span>(stations[, <span class="fu">c</span>(<span class="st">'USAF'</span>, <span class="st">'CTRY'</span>, <span class="st">'STATE'</span>)])</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Dropping NAs</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>stations <span class="ot">&lt;-</span> stations[<span class="sc">!</span><span class="fu">is.na</span>(stations<span class="sc">$</span>USAF), ]</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Removing duplicates</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>stations <span class="ot">&lt;-</span> stations[<span class="sc">!</span><span class="fu">duplicated</span>(stations<span class="sc">$</span>USAF), ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>#1</strong></p>
<p>The median station for temperature, wind speed, and atmospheric pressure are all separate stations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>temp_med <span class="ot">&lt;-</span> <span class="fu">quantile</span>(met_avg<span class="sc">$</span>temp, <span class="fl">0.5</span>, <span class="at">na.rm =</span> T)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>wind_med <span class="ot">&lt;-</span> <span class="fu">quantile</span>(met_avg<span class="sc">$</span>wind.sp, <span class="fl">0.5</span>, <span class="at">na.rm =</span> T)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>atm_med <span class="ot">&lt;-</span> <span class="fu">quantile</span>(met_avg<span class="sc">$</span>atm.press, <span class="fl">0.5</span>, <span class="at">na.rm =</span> T)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>temp_station <span class="ot">&lt;-</span> met_avg<span class="sc">$</span>USAFID[<span class="fu">which.min</span>(<span class="fu">abs</span>(met_avg<span class="sc">$</span>temp) <span class="sc">-</span> temp_med)]</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>wind_station <span class="ot">&lt;-</span> met_avg<span class="sc">$</span>USAFID[<span class="fu">which.min</span>(<span class="fu">abs</span>(met_avg<span class="sc">$</span>wind.sp) <span class="sc">-</span> wind_med)]</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>atm_station <span class="ot">&lt;-</span> met_avg<span class="sc">$</span>USAFID[<span class="fu">which.min</span>(<span class="fu">abs</span>(met_avg<span class="sc">$</span>atm.press) <span class="sc">-</span> atm_med)]</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(temp_station, wind_station, atm_station)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 723930 724190 723273</code></pre>
</div>
</div>
<p><strong>#2</strong></p>
<p>These are the stations that are at the median latitude and longitude for each state.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>met_stations <span class="ot">&lt;-</span> <span class="fu">merge</span>(met_avg, stations, </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>                      <span class="at">by.x =</span> <span class="st">"USAFID"</span>, </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">by.y =</span> <span class="st">"USAF"</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>state_medians <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(<span class="fu">cbind</span>(lat, lon) <span class="sc">~</span> STATE, </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>                           <span class="at">data =</span> met_stations,</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>                           <span class="at">FUN =</span> median, <span class="at">na.rm =</span> T)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>state_medians</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   STATE      lat        lon
1     AL 32.34150  -86.50849
2     AR 35.33300  -92.47001
3     AZ 33.54842 -111.44743
4     CA 34.89914 -119.20600
5     CO 39.23000 -105.01579
6     CT 41.48278  -72.82800
7     DE 39.13300  -75.46700
8     FL 28.43374  -81.77500
9     GA 33.35508  -83.83000
10    IA 42.05106  -93.12153
11    ID 43.56700 -114.21500
12    IL 40.04000  -88.95000
13    IN 40.23400  -86.29600
14    KS 38.57496  -97.27100
15    KY 37.85018  -85.28353
16    LA 30.78003  -92.01442
17    MA 42.13150  -70.98270
18    MD 39.16706  -76.42900
19    ME 44.31600  -69.66700
20    MI 42.77465  -84.67521
21    MN 44.83186  -94.05100
22    MO 38.62400  -92.38041
23    MS 32.33583  -89.05173
24    MT 46.08138 -108.99841
25    NC 35.19700  -78.88000
26    NE 41.21428  -98.97400
27    NH 43.27800  -71.50224
28    NJ 40.10800  -74.45850
29    NM 35.03975 -105.14103
30    NV 39.29577 -116.02564
31    NY 42.64300  -75.41193
32    OH 40.70800  -82.87821
33    OK 35.53400  -97.60075
34    OR 42.15667 -123.11740
35    PA 40.46300  -76.89764
36    RI 41.62873  -71.46200
37    SC 34.21846  -81.02689
38    SD 44.05100  -99.84222
39    TN 36.00000  -86.52000
40    TX 30.74246  -97.68093
41    UT 39.91400 -111.98895
42    VA 37.36136  -77.24400
43    VT 43.86850  -72.78200
44    WI 43.95850  -89.48563
45    WV 39.09036  -80.88457
46    WY 42.85807 -107.57500</code></pre>
</div>
</div>
<p><strong>#3</strong></p>
<p>For most states, the stations at the mean and median latitude and longitude are near the middle of the state. However, for some states, such as Oregon and Minnesota, the station is not at the middle of the state.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>state_means <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(<span class="fu">cbind</span>(lat, lon) <span class="sc">~</span> STATE, </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>                           <span class="at">data =</span> met_stations,</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>                           <span class="at">FUN =</span> mean, <span class="at">na.rm =</span> T)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>closest_stations <span class="ot">&lt;-</span> <span class="fu">merge</span>(met_stations, state_means, <span class="at">by =</span> <span class="st">"STATE"</span>,</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>                          <span class="at">suffixes =</span> <span class="fu">c</span>(<span class="st">""</span>, <span class="st">"_mean"</span>))</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>closest_stations<span class="sc">$</span>distance <span class="ot">&lt;-</span> <span class="fu">sqrt</span>((closest_stations<span class="sc">$</span>lat <span class="sc">-</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>                                     closest_stations<span class="sc">$</span>lat_mean)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> </span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>                                    (closest_stations<span class="sc">$</span>lon <span class="sc">-</span> </span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>                                       closest_stations<span class="sc">$</span>lon_mean)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>closest_by_state <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(<span class="fu">split</span>(closest_stations,</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>                                                closest_stations<span class="sc">$</span>STATE), </span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>                                          <span class="cf">function</span>(x) x[<span class="fu">which.min</span>(x<span class="sc">$</span>distance), ]))</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="fu">leaflet</span>() <span class="sc">%&gt;%</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addTiles</span>() <span class="sc">%&gt;%</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addCircleMarkers</span>(<span class="at">data =</span> state_medians, <span class="sc">~</span>lon, <span class="sc">~</span>lat, <span class="at">color =</span> <span class="st">"blue"</span>,</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>                   <span class="at">group =</span> <span class="st">"Median Stations"</span>, <span class="at">popup =</span> <span class="sc">~</span>STATE) <span class="sc">%&gt;%</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addCircleMarkers</span>(<span class="at">data =</span> closest_by_state, <span class="sc">~</span>lon, <span class="sc">~</span>lat, <span class="at">color =</span> <span class="st">"red"</span>,</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>                   <span class="at">group =</span> <span class="st">"Closest to Mean"</span>, <span class="at">popup =</span> <span class="sc">~</span>STATE) <span class="sc">%&gt;%</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addLayersControl</span>(<span class="at">overlayGroups =</span> <span class="fu">c</span>(<span class="st">"Meq1qdian Stations"</span>, <span class="st">"Closest to Mean"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="leaflet html-widget html-fill-item" id="htmlwidget-2160ac4ae4034788f726" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-2160ac4ae4034788f726">{"x":{"options":{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}}},"calls":[{"method":"addTiles","args":["https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",null,null,{"minZoom":0,"maxZoom":18,"tileSize":256,"subdomains":"abc","errorTileUrl":"","tms":false,"noWrap":false,"zoomOffset":0,"zoomReverse":false,"opacity":1,"zIndex":1,"detectRetina":false,"attribution":"&copy; <a href=\"https://openstreetmap.org/copyright/\">OpenStreetMap<\/a>,  <a href=\"https://opendatacommons.org/licenses/odbl/\">ODbL<\/a>"}]},{"method":"addCircleMarkers","args":[[32.3415,35.333,33.54842105263157,34.89914457831325,39.23,41.48277777777778,39.133,28.43373809523809,33.35508450704225,42.05106428571428,43.567,40.04,40.234,38.57495833333333,37.85017639257295,30.78002575152407,42.1315,39.16705633802817,44.316,42.77465,44.83186111111111,38.624,32.33583333333333,46.08138368055555,35.197,41.21428045112782,43.278,40.108,35.03975,39.29577380952381,42.643,40.708,35.534,42.15666666666667,40.463,41.62873170731707,34.21845774647888,44.051,36,30.74245833333333,39.914,37.36135714285714,43.8685,43.9585,39.09036408730158,42.85807317073171],[-86.50848947368422,-92.47001388888889,-111.4474285714286,-119.206,-105.0157887323944,-72.828,-75.467,-81.77500000000001,-83.83,-93.12152816901408,-114.215,-88.95,-86.29600000000001,-97.27100220264317,-85.28352816901409,-92.01441666666666,-70.98269791666667,-76.429,-69.667,-84.67521428571429,-94.051,-92.38040625000001,-89.05172899728998,-108.9984114583333,-78.88,-98.97399999999999,-71.50224210526316,-74.45849999999999,-105.1410277777778,-116.0256428571429,-75.41193055555556,-82.87821428571428,-97.60075000000001,-123.1174010416667,-76.89764285714286,-71.462,-81.0268930583501,-99.84222222222222,-86.52,-97.68092857142858,-111.98895,-77.244,-72.78200000000001,-89.48563253012048,-80.88456944444445,-107.575],10,null,"Median Stations",{"interactive":true,"className":"","stroke":true,"color":"blue","weight":5,"opacity":0.5,"fill":true,"fillColor":"blue","fillOpacity":0.2},null,null,["AL","AR","AZ","CA","CO","CT","DE","FL","GA","IA","ID","IL","IN","KS","KY","LA","MA","MD","ME","MI","MN","MO","MS","MT","NC","NE","NH","NJ","NM","NV","NY","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VA","VT","WI","WV","WY"],null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"addCircleMarkers","args":[[32.383,34.91702857142857,33.46683333333333,36.319,39.229,41.51,39.133,27.96311111111111,32.68891666666667,42.111,44.523,40.483,39.825,38.8,37.90007692307692,31.395,42.191,39.17452380952381,44.533,42.77465,44.21716666666666,38.096,32.32,45.80532291666667,35.17398159509202,41.433,43.567,40.01698795180723,35.003,38.051,42.206,40.616,35.534,42.37713541666667,40.296,41.72446341463414,33.94314285714286,44.38105633802817,36.009,30.74091666666667,40.219,37.51011904761905,43.533,44.35902816901409,39.29601388888889,43.06443373493976],[-86.35062337662337,-92.14991428571429,-111.7328611111111,-119.628,-106.316,-72.828,-75.467,-82.53844444444445,-83.65216666666667,-92.916,-114.215,-88.95,-86.29600000000001,-97.65000000000001,-85.96705494505494,-92.291,-71.17400000000001,-76.68080952380953,-69.667,-84.59999999999999,-93.91705555555556,-92.55294444444444,-90.07925,-108.5398229166667,-79.00903067484663,-99.633,-71.43300000000001,-74.59990361445783,-105.662,-117.09,-75.98042857142858,-83.06397222222222,-97.64700000000001,-122.8708020833333,-78.31999999999999,-71.43300000000001,-81.11785714285713,-100.2850281690141,-86.52,-98.23516666666667,-111.723,-77.32435714285714,-72.95,-89.83705633802818,-80.22898611111111,-108.4568915662651],10,null,"Closest to Mean",{"interactive":true,"className":"","stroke":true,"color":"red","weight":5,"opacity":0.5,"fill":true,"fillColor":"red","fillOpacity":0.2},null,null,["AL","AR","AZ","CA","CO","CT","DE","FL","GA","IA","ID","IL","IN","KS","KY","LA","MA","MD","ME","MI","MN","MO","MS","MT","NC","NE","NH","NJ","NM","NV","NY","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VA","VT","WI","WV","WY"],null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"addLayersControl","args":[[],["Meq1qdian Stations","Closest to Mean"],{"collapsed":true,"autoZIndex":true,"position":"topright"}]}],"limits":{"lat":[27.96311111111111,46.08138368055555],"lng":[-123.1174010416667,-69.667]}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p><strong>#4</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># avg state temps</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>state_temps <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(temp <span class="sc">~</span> STATE, <span class="at">data =</span> met_stations,</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">FUN =</span> mean, <span class="at">na.rm =</span> T)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co"># classify states by temps</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>state_temps<span class="sc">$</span>temp_cat <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(state_temps<span class="sc">$</span>temp <span class="sc">&lt;</span> <span class="dv">20</span>, <span class="st">"low"</span>,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>                               <span class="fu">ifelse</span>(state_temps<span class="sc">$</span>temp <span class="sc">&lt;</span> <span class="dv">25</span>, <span class="st">"mid"</span>,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>                                      <span class="st">"high"</span>))</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="co"># merge original data with state temp cat</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>met <span class="ot">&lt;-</span> <span class="fu">merge</span>(met, stations, </span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>             <span class="at">by.x =</span> <span class="st">"USAFID"</span>,</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>             <span class="at">by.y =</span> <span class="st">"USAF"</span>)</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>met <span class="ot">&lt;-</span> <span class="fu">merge</span>(met, state_temps[ ,</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>                               <span class="fu">c</span>(<span class="st">"STATE"</span>, <span class="st">"temp_cat"</span>)],</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>             <span class="at">by =</span> <span class="st">"STATE"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># summary table</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="co"># unique states by category</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>num_states <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(STATE <span class="sc">~</span> temp_cat, </span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">data =</span> <span class="fu">unique</span>(met[ , <span class="fu">c</span>(<span class="st">"STATE"</span>, <span class="st">"temp_cat"</span>)]),</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>                        <span class="at">FUN =</span> length)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co"># count total records by cat</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>num_records <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(USAFID <span class="sc">~</span> temp_cat, <span class="at">data =</span> met, <span class="at">FUN =</span> length)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="co"># count unique stations by category</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>num_stations <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(USAFID <span class="sc">~</span> temp_cat,</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>                         <span class="at">data =</span> <span class="fu">unique</span>(met[ , <span class="fu">c</span>(<span class="st">"USAFID"</span>, <span class="st">"temp_cat"</span>)]),</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>                        <span class="at">FUN =</span> length)</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate means by cat</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>mean_stats <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(<span class="fu">cbind</span>(temp, wind.sp, atm.press) <span class="sc">~</span> temp_cat,</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>                         <span class="at">data =</span> met, <span class="at">FUN =</span> mean, <span class="at">na.rm =</span> T)</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="co"># count NAs by cat</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>na_temp <span class="ot">&lt;-</span> <span class="fu">tapply</span>(met<span class="sc">$</span>temp, met<span class="sc">$</span>temp_cat, <span class="cf">function</span>(x) <span class="fu">sum</span>(<span class="fu">is.na</span>(x)))</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>na_wind <span class="ot">&lt;-</span> <span class="fu">tapply</span>(met<span class="sc">$</span>wind.sp, met<span class="sc">$</span>temp_cat, <span class="cf">function</span>(x) <span class="fu">sum</span>(<span class="fu">is.na</span>(x)))</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>na_atm <span class="ot">&lt;-</span> <span class="fu">tapply</span>(met<span class="sc">$</span>atm.press, met<span class="sc">$</span>temp_cat, <span class="cf">function</span>(x) <span class="fu">sum</span>(<span class="fu">is.na</span>(x)))</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a><span class="co"># final summary</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>final_summary <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">temp_cat =</span> num_states<span class="sc">$</span>temp_cat,</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">num_states =</span> num_states<span class="sc">$</span>STATE,</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">num_records =</span> num_records<span class="sc">$</span>USAFID,</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">na_temp =</span> <span class="fu">as.numeric</span>(na_temp[num_states<span class="sc">$</span>temp_cat]),</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">na_wind =</span> <span class="fu">as.numeric</span>(na_wind[num_states<span class="sc">$</span>temp_cat]),</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">na_atm =</span> <span class="fu">as.numeric</span>(na_atm[num_states<span class="sc">$</span>temp_cat]),</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean_temp =</span> mean_stats<span class="sc">$</span>temp,</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean_wind_sp =</span> mean_stats<span class="sc">$</span>wind.sp,</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean_atm_press =</span> mean_stats<span class="sc">$</span>atm.press</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(final_summary)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  temp_cat num_states num_records na_temp na_wind na_atm mean_temp mean_wind_sp
1     high         16       96634    2917    4222  68392  26.97418     2.544305
2      low          2        2416      46     121   1445  20.10926     1.713170
3      mid         28      125174    3063    4212  85640  22.77705     2.310667
  mean_atm_press
1       1015.247
2       1017.834
3       1017.526</code></pre>
</div>
</div>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>